{% load static %}
{% load array %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'web/css/main.css' %}">
    <title>Главная</title>
</head>
<body>
    <div id="banner">
        <span id="name">Оборудование</span>
    </div>

    <div id="content">
        <span id="info">Список устройств</span>
        
        <div id="pages_container">
            <div id="pages" style="margin-top: 10px; font-size: 16px">
                <button onclick="delta_page(-1)" id="prev_page">Предыдущая</button>
                Страница
                <input id="page_num_input" value="{{ page|add:1 }}" style="width: 4em"></input>
                из
                <span id="page_count">{{ page_count|add:1 }}</span>
                <button onclick="switch_page()">Перейти</button>
                <button onclick="delta_page(1)" id="next_page">Следующая</button>
                
                <br style="margin-bottom: 10px">
                Записей в странице: <input id="records_in_page" value="{{ pagesize }}" style="width: 4em"></input>
            </div>
            
            <button id="print_version" onclick="open_printable_ver()">Версия для печати</button>
        </div>

        <table border>
            <thead>
                <th>N</th>
                <th>Инвертарный номер</th>
                <th>Тип устройства</th>
                <th>Производитель</th>
                <th>Модель</th>
                <th>Серийный номер</th>
                <th>Статус</th>
                <th>Действие</th>
            </thead>
            <tbody>
                {% for i in table_contents %}
                    <tr id="{{ i.1.inv_num }}" title="{{ i.1.description }}">
                        <td>{{ i.0 }}</td>
                        <td>{{ i.1.inv_num }}</td>
                        <td>{{ i.1.type }}</td>
                        <td>{{ i.1.vendor }}</td>
                        <td>{{ i.1.model }}</td>
                        <td>{{ i.1.serial }}</td>
                        <td>{{ i.1.status }}</td>
                        <td>
                            <button class="button" id="edit_btn" onclick="edit_mode('{{ i.1.inv_num }}')">Изменить</button>
                            <button class="button" id="delete_btn" onclick="delete_hw('{{ i.1.inv_num }}')">Удалить</button>
                        </td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="{{ fields.keys|len_array|add:1 }}" id="add_device_field" onclick="show_add_dev()">
                        <div id="add_device">
                            <span id="add_device_sign">+</span>
                            <span id="add_device_text">Добавить новое устройство</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div id="add_dev_modal" class="modal">
            <div class="modal-content">
                <div class="titlebox">
                    <span class="close" onclick="hide_add_dev()">&times;</span>
                    <span class="title">
                        <b id="add_dev_text">Добавить устройство</b>
                        <b id="edit_dev_text">Редактировать устройство</b>
                    </span>
                </div>
                <table border="">
                    <tbody id="add_dev_table">
                        <!-- Fields -->
        
                        {% for id, value in fields.items %}
                            <tr>
                                <td>{{ value.show }}</td>
                                <td>
                                    {% if value.type == "input" %}
                                    <input id="{{ id }}"></input>
                                    {% elif value.type == "dropdown" %}
                                    <select id="{{ id }}">
                                        {% for elem in value.elements %}
                                        <option value="{{ elem }}">{{ elem }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif value.type == "textbox" %}
                                    <textarea id="{{ id }}"></textarea>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                    <button class="button" style="margin-top: 5px" id="add_dev_btn" onclick="add_device()">Окей</button>
              </div>
        </div>
    </div>
</body>
</html>

<script src="{% static 'web/js/functions.js' %}"></script>
<script>
    var date = new Date();
    const urlParams = new URLSearchParams(window.location.search);

    var page_count = Number(document.getElementById("page_count").innerHTML);

    document.getElementById("info").innerHTML += " на " + 
                        date.getDate() + " " + 
                        months[date.getMonth()] + " " + 
                        date.getFullYear() + " г. " +
                        "(" + String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ")"

    // Modal window control for adding

    var modal_add = document.getElementById("add_dev_modal")

    var is_editing = false;
    var edit_num = 0;
    var edit_orig_datas = null;

    function edit_mode(num) {
        num = Number(num)
        is_editing = true;
        edit_num = num;

        edit_elem = document.getElementById(String(num))
        
        cols = Array.from(edit_elem.childNodes).filter(a => a.tagName == "TD")
        cols = cols.slice(1, cols.length - 1)  // Needed columns (ID and actions are not)

        datas = cols.map(a => a.childNodes[0].data)  // Get values from a row's colums
        
        datas.push(edit_elem.getAttribute("title"))  // Add description

        edit_orig_datas = datas
        
        show_add_dev()

        form_elems = get_add_form_elems()

        for(i in form_elems) {
            form_elems[i].value = datas[i]
        }
    }

    function show_add_dev() {
        modal_add.style.display = "flex"

        if(is_editing) {
            document.getElementById("add_dev_text").style.display = "none"
            document.getElementById("edit_dev_text").style.display = "block"
        } else {
            document.getElementById("add_dev_text").style.display = "block"
            document.getElementById("edit_dev_text").style.display = "none"
        }
    }

    function hide_add_dev() {
        modal_add.style.display = "none"
    
        is_editing = false;
    }

    // Work with add form

    var add_form = document.getElementById("add_dev_table")
    var add_form_btn = document.getElementById("add_dev_btn")
    var fields = [{% for id, value in fields.items %}"{{ id }}", {% endfor %}];

    function get_add_form_elems() {
        if(modal_add.style.display == "none" || modal_add.style.display == "") {
            return;
        }

        var supported = [];

        for(var i of add_form.childNodes.entries()) {
            if(i[1].tagName == "TR") {
                supported.push(i[1])
            }
        }

        var elems = [];

        for(var i of supported) {
            elems.push(i.childNodes[3].childNodes[1])  // NOTE: Fourth element is a second <td> tag and input is located at the second element of <td> tag!
        }

        return elems;
    }

    function get_form_values(elems) {
        var request = {};

        for(var i in fields) {
            request[fields[i]] = elems[i].value
        }

        return request;
    }
    
    function add_device() {
        add_form_btn.disabled = true;

        elems = get_add_form_elems()
        values = get_form_values(elems)

        if(!is_editing) {
            resp = send_add_form_data(values)
            
            resp.then((data) => {
                if(data.ok) {
                    hide_add_dev();
                    location.reload()
                } else {
                    for(i of elems) {
                        i.style.backgroundColor = "white"
                    }
                    document.getElementById(data.message).style.backgroundColor = "red"
                }
            })
        } else {
            resp = send_edit_form_data(arrays_to_object(fields, edit_orig_datas), values)
            
            resp.then((data) => {
                console.log(data)
                if(data.ok) {
                    hide_add_dev();
                    location.reload()
                } else {
                    for(i of elems) {
                        i.style.backgroundColor = "white"
                    }
                    document.getElementById(data.message).style.backgroundColor = "red"
                }
            })
        }
        
        add_form_btn.disabled = false;
    }

    window.onload = () => {
        var supported = [];

        for(var i of add_form.childNodes.entries()) {
            if(i[1].tagName == "TR") {
                supported.push(i[1])
            }
        }

        for(var i of supported) {
            i.childNodes[3].childNodes[1].value = ""
        }

        if(Number(urlParams.get('p')) == 0) {
            document.getElementById("prev_page").disabled = true;
        } else if(Number(urlParams.get('p')) + 1 >= page_count) {
            document.getElementById("next_page").disabled = true;
        }
    }
</script>