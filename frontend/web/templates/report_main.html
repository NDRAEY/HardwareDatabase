{% load static %}
{% load array %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'web/modal.css' %}">
    <title>Главная</title>
</head>
<body>
    <div id="banner">
        <span id="name">Оборудование</span>
    </div>

    <div id="content">
        <span id="info">Список устройств</span>
        
        <table border>
            <thead>
                <th>N</th>
                <th>Инвертарный номер</th>
                <th>Тип устройства</th>
                <th>Производитель</th>
                <th>Модель</th>
                <th>Серийный номер</th>
                <th>Статус</th>
                <th>Действие</th>
            </thead>
            <tbody>
                {% for i in table_contents %}
                    <tr id="{{ i.1.inv_num }}" title="{{ i.1.description }}">
                        <td>{{ i.0 }}</td>
                        <td>{{ i.1.inv_num }}</td>
                        <td>{{ i.1.type }}</td>
                        <td>{{ i.1.vendor }}</td>
                        <td>{{ i.1.model }}</td>
                        <td>{{ i.1.serial }}</td>
                        <td>{{ i.1.status }}</td>
                        <td>
                            <button class="button" id="edit_btn">Изменить</button>
                            <button class="button" id="delete_btn" onclick="delete_hw({{ i.1.inv_num }})">Удалить</button>
                        </td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="{{ fields.keys|len_array|add:1 }}" id="add_device_field" onclick="show_add_dev()">
                        <div id="add_device">
                            <span id="add_device_sign">+</span>
                            <span id="add_device_text">Добавить новое устройство</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div id="add_dev_modal" class="modal">
            <div class="modal-content">
                <div class="titlebox">
                    <span class="close" onclick="hide_add_dev()">&times;</span>
                    <span class="title">
                        <b>Добавить устройство</b>
                    </span>
                </div>
                <table border="">
                    <tbody id="add_dev_table">
                        <!-- Fields -->
        
                        {% for id, value in fields.items %}
                            <tr>
                                <td>{{ value.show }}</td>
                                <td>
                                    {% if value.type == "input" %}
                                    <input id="{{ id }}"></input>
                                    {% elif value.type == "dropdown" %}
                                    <select id="{{ id }}">
                                        {% for elem in value.elements %}
                                        <option value="{{ elem }}">{{ elem }}</option>
                                        {% endfor %}
                                    </select>
                                    {% elif value.type == "textbox" %}
                                    <textarea id="{{ id }}"></textarea>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                    <button class="button" style="margin-top: 5px" id="add_dev_btn" onclick="add_device()">Окей</button>
              </div>
        </div>
    </div>
</body>
</html>

<style>
    body {
        font-family: 'Lucida Sans', sans-serif;
    }

    #banner {
        display: flex;
        align-items: center;
        height: 70px;
    
        background-color: #3abb44 !important;
    
        margin-bottom: 20px;
    }

    #banner #name {
        font-size: 24px;
        margin-left: 20px;
    }

    #info {
        font-size: 20px;
        font-weight: bold;
    }

    table {
        margin-top: 20px;
        border-collapse: collapse;
    }

    table thead th {
        text-align: left;
        padding: 10px;
    }

    table tbody tr td {
        padding: 10px;
    }

    table tbody tr:nth-child(even) {
        background-color: #999;
    }

    #content {
        margin-left: 10px;
    }

    #add_device_field {
        padding: 15px;
        text-align: center;
        background-color: #ccc;
    
        font-weight: bold;
    }

    #add_device {
        display: flex;

        align-items: center;
        justify-content: center;
    }

    #add_device_sign {
        font-size: 36px;

        padding-right: 6px;
    }

    .button {
        padding: 6px;

        border: black 1px solid;
        border-radius: 7px;
    }

    #edit_btn {
        background-color: rgb(59, 59, 196);

        color: white;
    }

    #delete_btn {
        background-color: red;
        color: white;
    }

    .modal .modal-content .titlebox {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal .modal-content .titlebox .close {
        order: 1;
    }

    .modal .modal-content .titlebox .title {
        font-size: 18px;
        order: 0;
    }
</style>

<script>
    var months = [
        "января",
        "февраля",
        "марта",
        "апреля",
        "мая",
        "июня",
        "июля",
        "августа",
        "сентября",
        "октября",
        "ноября",
        "декабря"
    ]

    var date = new Date();

    document.getElementById("info").innerHTML += " на " + 
                        date.getDate() + " " + 
                        months[date.getMonth()] + " " + 
                        date.getFullYear() + " г. " +
                        "(" + String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ")"

    // Modal window control for adding

    var modal_add = document.getElementById("add_dev_modal")
    
    function show_add_dev() {
        modal_add.style.display = "flex"
    }

    function hide_add_dev() {
        modal_add.style.display = "none"
    }

    // Work with add form

    var add_form = document.getElementById("add_dev_table")
    var add_form_btn = document.getElementById("add_dev_btn")
    var fields = [{% for id, value in fields.items %}"{{ id }}", {% endfor %}];

    function get_add_form_elems() {
        if(modal_add.style.display == "none" || modal_add.style.display == "") {
            return;
        }

        var supported = [];

        for(var i of add_form.childNodes.entries()) {
            if(i[1].tagName == "TR") {
                supported.push(i[1])
            }
        }

        var elems = [];

        for(var i of supported) {
            elems.push(i.childNodes[3].childNodes[1])  // NOTE: Fourth element is a second <td> tag and input is located at the second element of <td> tag!
        }

        return elems;
    }

    function get_form_values(elems) {
        var request = {};

        for(var i in fields) {
            request[fields[i]] = elems[i].value
        }

        return request;
    }

    function object_to_get(data) {
        var total = "?"

        for(i of Object.keys(data)) {
            total += i + "=" + data[i] + "&"
        }

        return total
    }

    function send_add_form_data(data) {
        let resp = fetch("/cmd" + object_to_get(data) + "cmd=new")
        let response = resp.then(response => {return response.json()})

        return response
    }

    function add_device() {
        add_form_btn.disabled = true;

        elems = get_add_form_elems()
        values = get_form_values(elems)

        resp = send_add_form_data(values)
        
        resp.then((data) => {
            if(data.ok) {
                hide_add_dev();
                location.reload()
            } else {
                for(i of elems) {
                    i.style.backgroundColor = "white"
                }
                document.getElementById(data.message).style.backgroundColor = "red"
            }
        })
        
        add_form_btn.disabled = false;
    }

    function get_data_in_table(inv_num) {
        row = document.getElementById(String(inv_num)).childNodes
        cols = []
        
        for(i of row) {
            if(i.tagName && i.tagName == "TD")
            cols.push(i.innerHTML)
        }

        cols = cols.slice(0, cols.length - 1)

        return cols
    }

    function delete_hw(inv_num) {
        dev = get_data_in_table(inv_num)
        really = confirm("Вы точно хотите удалить устройство: \"" + dev[2] + " " + dev[3] + " " + dev[4] + "\"?")
    
        if(really) {
            let resp = fetch("/cmd?inv_num=" + inv_num + "&cmd=del")
            resp.then(r => r.json()).then(j => {
                if(j.ok) {
                    location.reload()
                }
            })
        }
    }

    window.onload = () => {
        var supported = [];

        for(var i of add_form.childNodes.entries()) {
            if(i[1].tagName == "TR") {
                supported.push(i[1])
            }
        }

        for(var i of supported) {
            i.childNodes[3].childNodes[1].value = ""
        }
    }
</script>